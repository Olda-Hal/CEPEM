FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /app

# Copy project files from both directories
COPY DatabaseAPI.Tests/*.csproj ./DatabaseAPI.Tests/
COPY DatabaseAPI/*.csproj ./DatabaseAPI/
RUN dotnet restore ./DatabaseAPI.Tests/

# Copy source code
COPY DatabaseAPI.Tests/ ./DatabaseAPI.Tests/
COPY DatabaseAPI/ ./DatabaseAPI/

# Run tests with coverage - continue on failure
WORKDIR /app/DatabaseAPI.Tests
RUN dotnet test --collect:"XPlat Code Coverage" --results-directory ./TestResults --logger trx || true

# Generate coverage report - continue on failure
RUN dotnet tool install -g dotnet-reportgenerator-globaltool || true
ENV PATH="$PATH:/root/.dotnet/tools"
RUN reportgenerator -reports:"./TestResults/*/coverage.cobertura.xml" -targetdir:"./TestResults/CoverageReport" -reporttypes:Html || true

# Copy test results for output
FROM alpine:latest
WORKDIR /results
COPY --from=build /app/DatabaseAPI.Tests/TestResults ./
CMD ["sh", "-c", "cp -r . /results/database-api/ 2>/dev/null || true; find . -name '*.trx' -exec cat {} \\; 2>/dev/null || true; find . -name 'coverage.cobertura.xml' -exec cat {} \\; 2>/dev/null || true"]
